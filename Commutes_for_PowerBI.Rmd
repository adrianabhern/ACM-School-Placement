```{r}
rm(list=ls(all=TRUE))

dataset <- data.frame(FP = 1)
dataset$FP[1]<-"C:\\Users\\CLuedtke\\ACM-School-Placement\\"
dataset$calc_commutes[1] <-"Yes"
dataset$API_Key[1] <- ""
dataset$used_surveygizmo[1] <- "No"
dataset$arrival_date[1] <- "2017-08-21"

```

```{r}
if(dataset$calc_commutes[1] == "Yes"){
  library(dplyr)
  library(tidyr)
  library(readxl)
  library(XML)
  library(RCurl)
  
  root_dir <- dataset$FP[1]
  api <- dataset$API_Key[1]
  used_surveygizmo <- dataset$used_surveygizmo[1]
  arrival_date <- dataset$arrival_date[1]
  
  # acm_df <- dataset
  acm_df <- read.csv(file = paste(root_dir, "Input 1 - ACM Data.csv", sep = ""), check.names=FALSE)
  school_df <- read_excel(path = paste(root_dir, "Input 2 - School Data.xls", sep = ""))
  
  if(used_surveygizmo == "Yes"){
    vars_df <- read_excel(path = paste(root_dir, "Survey Items to Variable Names.xls", sep = ""))
    
    # Rename Headers
    for (x in names(acm_df)){
      if(x %in% vars_df$Survey.Item){
        names(acm_df)[names(acm_df) == x] <- as.character(vars_df$Variable.Name[vars_df$Survey.Item == x])
      }
    }
  }
  
  school_df$`ACM Start Time` <- substr(strptime(school_df$`ACM Start Time`, "%I:%M%p" ),12,19)
  school_df$`ACM Start Time` <- as.POSIXct(paste(arrival_date, school_df$`ACM Start Time`))
  attributes(school_df$`ACM Start Time`)$tzone <- "GMT"
  school_df$`ACM Start Time` <- as.integer(school_df$`ACM Start Time`)
  
  #school_df$`ACM End Time` <- substr(strptime(school_df$`ACM End Time`, "%I:%M%p" ),12,19)
  #school_df$`ACM End Time` <- as.POSIXct(paste("2020-09-07", school_df$`ACM End Time`))
  #attributes(school_df$`ACM End Time`)$tzone <- "GMT" 
  #school_df$`ACM End Time` <- as.integer(school_df$`ACM Start Time`)
  
  # Convert 'Walking', 'Bicycling', 'Public Transportation' to 'transit'
  acm_df$Travel.Method <- as.character(acm_df$Travel.Method)
  acm_df$Travel.Method[!(acm_df$Travel.Method %in%  'Driving')] <- "transit"
  acm_df$Travel.Method[acm_df$Travel.Method %in% 'Driving'] <- "driving"
  
  # Combine address data into one text string:
  acm_df$Full.Address <- paste(as.character(acm_df$"Res.Address.Line.1"), as.character(acm_df$"Res.City"), as.character(acm_df$"Res.State"), as.character(acm_df$"Res.Postal.Code"))
  
  # Replace spaces with "+" and remove commas (requests to google maps API cannot include spaces)
  acm_df$Full.Address <- gsub(" ", "+", acm_df$Full.Address)
  acm_df$Full.Address <- gsub(",", "", acm_df$Full.Address)
  school_df$Address.Clean <- gsub(" ", "+", school_df$Address)
  school_df$Address.Clean <- gsub(",", "", school_df$Address.Clean)
  
  # origin = "424+W+Diversey+Pwky+Chicago++IL+60614"
  # destination = "7424+S+Morgan+St+Chicago+IL+60621"
  # most = "transit"
  # arrival_time = 1503491400
  
  gmapsdistance = function(origin, destination, mode, arrival_time, key, api) {
  
    data = expand.grid(or = origin, de = destination)
    data$Time = NA
    data$Distance = NA
    data$status = "OK"
    
    url = paste0("https://maps.googleapis.com/maps/api/distancematrix/xml?origins=", origin,
                 "&destinations=", destination,
                 "&mode=", mode,
                 "&units=metric",
                 "&arrival_time=", arrival_time,
                 "&key=", api)
    
    # Call the Google Maps Webservice and store the XML output in webpageXML
    webpageXML = xmlParse(getURL(url));
          
    # Extract the results from webpageXML
    results = xmlChildren(xmlRoot(webpageXML))
          
    # Check the status of the request and throw an error if the request was denied
    request.status = as(unlist(results$status[[1]]), "character")
    
    # Check for google API errors
    if (!is.null(results$error_message)) {
      stop(paste(c("Google API returned an error: ", xmlValue(results$error_message)), sep = ""))
    }
    
    if (request.status == "REQUEST_DENIED") {
      data$status = "REQUEST_DENIED"
      # stop(as(results$error_message[1]$text, "character"))
    }
    
    # Extract results from results$row
    rowXML = xmlChildren(results$row[[1L]])
    Status = as(rowXML$status[1]$text, "character")
    
    if (Status == "ZERO_RESULTS") {
      # stop(paste0("Google Maps is not able to find a route between ", data$or[i]," and ", data$de[i]))
      data$status = "ROUTE_NOT_FOUND"
    }
    
    if (Status == "NOT_FOUND") {
      # stop("Google Maps is not able to find the origin (", data$or[i],") or destination (", data$de[i], ")")
      data$status = "PLACE_NOT_FOUND"
    }
    
    # Check whether the user is over their query limit
    if (Status == "OVER_QUERY_LIMIT") {
      stop("You have exceeded your allocation of API requests for today.")
    }
    
    if(data$status == "OK"){
      data$Distance = as(rowXML$distance[1]$value[1]$text, "numeric")
      dur = grep("duration", names(rowXML), value = TRUE)
      data$Time = as(rowXML[[dur]][1L]$value[1L]$text, "numeric")
    } else {
      data$Distance = NA
      data$Time = NA
    }
    
    Distance = data$Distance[1]
    Time = data$Time[1]
    Stat = data$status[1]
    
    output = list(Time = Time,
                  Distance = Distance,
                  Status = Stat)
    
    return(output)
    
  }
  
  # Create an empty dataframe that we will fill with commute times
  acm_commutes <- data.frame()
  
  for (x in acm_df$acm_id[(acm_df$Res.Address.Line.1 != "") & 
                          !(is.na(acm_df$Res.Address.Line.1))]){
    
    for(y in school_df$Address.Clean){
      
      acm_commute <- data.frame("acm_id" = x,
                                "Full.Name" = as.character(acm_df$Full.Name[acm_df$acm_id == x]),
                                "Home.Address" = as.character(acm_df$Full.Address[acm_df$acm_id == x]),
                                "School.Address" = y,
                                "School" = school_df$School[school_df$Address.Clean == y],
                                "Commute.Time" = NA,
                                "Mode" = acm_df$Travel.Method[acm_df$acm_id == x],
                                "Status" = NA)
      
      commute = gmapsdistance(origin = acm_df$Full.Address[acm_df$acm_id == x], 
                              destination = y, 
                              mode = acm_df$Travel.Method[acm_df$acm_id == x],
                              arrival_time= school_df$`ACM Start Time`[school_df$Address.Clean == y],
                              api = api)
  
      acm_commute$"Commute.Time" = commute$Time[1]
      acm_commute$"Status" = commute$Status[1]
  
      rownames(acm_commute) <- c()
      
      acm_commutes <- rbind(acm_commutes, acm_commute)
    }
  }

  acm_commutes$Commute.Time <- as.numeric(as.character(acm_commutes$Commute.Time))
  
  acm_commutes <- acm_commutes %>% 
    arrange(Commute.Time) %>%
    group_by(acm_id) %>%
    mutate(Commute.Rank = rank(Commute.Time, ties.method = "min")) %>%
    ungroup() %>%
    arrange(acm_id)
  
  # Write to .csv, which will be referenced by main algorithm
  write.table(acm_commutes, file = paste(root_dir, "ACM Commutes.csv", sep = ""), sep=",", row.names=FALSE)
}

```