---
title: "Placement Algorithm v1.2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(readxl)
require(dplyr)
require(tidyr)
require(data.table)
```

```{r "Set Parameters""}
# Initialize
dataset <- data.frame(FP = 1)
# Data Source Parameters
dataset$FP[1] <-"C:\\Users\\Alexander\\GitHub\\ACM-School-Placement\\"
dataset$used_surveygizmo[1] <- "No"

# Algorithm Settings
dataset$number_iterations[1] <- 2000
dataset$ij[1] <- "Do nothing with IJ Teams."

# Set Firm Constraints
dataset$prevent_roommates[1] <-"Yes"
dataset$consider_HS_elig[1] <- "No"

# Set Soft Constraints
dataset$commute_factor = 0
dataset$age_factor = 0
dataset$ethnicity_factor= 1
dataset$Edscore_factor = 0
dataset$Tutoring_factor = 0
dataset$Spanish_factor = 0
dataset$Math_factor = 0
dataset$Gender_factor = 1
dataset$preserve_ij_factor = 1
```

```{r "Load Parameters & Data""}
root_dir <- dataset$FP[1]
prevent_roommates <- dataset$prevent_roommates[1]
number_iterations <- dataset$number_iterations[1]
consider_commutes <- dataset$consider_commutes[1]
used_surveygizmo <- dataset$used_surveygizmo[1]
consider_HS_elig <- dataset$consider_HS_elig[1]
ij <- dataset$ij[1]
preserve_ij_factor <- dataset$preserve_ij_factor[1]

raw_acm <- read.csv('Input 1 - ACM Data.csv')
raw_school <- read_excel('Input 2 - School Data.xls')
```

```{r}
encode_acm_df <- function(df){

  acm_enc <- select(df, acm_id, Math.Confidence)
  
  # Ed Attainment
  acm_enc$Ed_HS <- as.numeric(grepl("High School/GED", df$Educational.Attainment))
  acm_enc$Ed_SomeCol <- grepl("Some College", df$Educational.Attainment) + grepl("Associate's Degree", df$Educational.Attainment)
  acm_enc$Ed_Col <- grepl("Bachelor's Degree", df$Educational.Attainment) + grepl("Master's Degree", df$Educational.Attainment)
  
  # Tutoring Experience
  acm_enc$HasTutored <- as.numeric(grepl("Yes", df$Tutoring.Experience))

  # Language Ability
  acm_enc$SpanishAble <- as.numeric(grepl("Spanish", df$Language.Ability.Spanish))
  acm_enc$Lang_Other <- ifelse(grepl("Spanish", df$Language.Ability.Spanish) == F & grepl("Yes", df$Language.Other.English), 1, 0)
  
  # Gender
  acm_enc$Male <- as.numeric(grepl("Male", df$Gender))
  acm_enc$Other.Gender <- as.numeric(!grepl("Male", df$Gender)&!grepl("Female", df$Gender))
  
  # Math Confidence
  acm_enc$Math.Confidence <- as.numeric(grepl(paste(c("Algebra I", "Algebra II", "Trigonometry", "Calculus or higher"), collapse = "|"), acm_enc$Math.Confidence))

  # Add in other features
  acm_enc <- acm_enc %>%
               left_join(., select(df,
                                   acm_id,
                                   Full.Name,
                                   Gender, 
                                   Manual.Placement, 
                                   Birth.Date,
                                   Race.Ethnicity,
                                   IJ.Placement,
                                   Prior.Rship.Name,
                                   Prior.Rship.Name1,
                                   Prior.Rship.Name2,
                                   Prior.Rship.Name3,
                                   Roommate.Names), by=c("acm_id" = "acm_id")) %>%
               mutate(days_old = as.integer(Sys.Date() - as.Date(as.character(df$Birth.Date), format="%m/%d/%Y"))) %>%
               replace_na(list(Lang_Other = 0, days_old = 0))

  acm_enc$Manual.Placement[acm_enc$Manual.Placement == ""] <- NA
  acm_enc$IJ.Placement[acm_enc$IJ.Placement == ""] <- NA

  return(acm_enc)
}
```

